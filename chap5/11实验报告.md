## 网络安全第五章实验报告

### 实验目的

- 掌握网络扫描之端口状态探测的基本原理

### 实验环境

python + scapy 2.4.3

nmap

### 网络拓扑结构

![1638145874599](1638145874599.png)

 网关 172.16.111.1 

![1638145922550](1638145922550.png)

 攻击者主机 kali-attacker 

![1638147401141](1638147401141.png)

 目标靶机 victim-kali-1 

![1638147417877](1638147417877.png)

### 实验要求

完成以下扫描技术的编程实现

- TCP connect scan / TCP stealth scan
- TCP Xmas scan / TCP fin scan / TCP null scan
- UDP scan
- 上述每种扫描技术的实现测试均需要测试端口状态为：开放、关闭和过滤状态时的程序执行结果
- 提供每一次扫描测试的抓包结果并分析与课本中的扫描方法原理是否相符？如果不同，试分析原因
- 在实验报告中详细说明实验网络环境拓扑、被测试 IP 的端口状态是如何模拟的
- （可选）复刻nmap的上述扫描技术实现的命令行参数开关

### 实验过程

1.端口状态模拟

关闭状态

```
sudo ufw disable
```

```
systemctl stop apache2
```

```
systemctl stop dnsmasq
```

开放状态

systemctl start apache2

systemctl start dnsmasq 

被过滤状态

```
sudo ufw enable && sudo ufw deny 80/tcp
sudo ufw enable && sudo ufw deny 53/udp
```

### TCP connect scan

#攻击者主机编写TCPconnect.py

```python
from scapy.all import *
def tcpconnect(dst_ip,dst_port,timeout=10):
    pkts=sr1(IP(dst=dst_ip)/TCP(dport=dst_port,flags="S"),timeout=timeout)
    if (pkts is None):
        print("FILTER")
    elif(pkts.haslayer(TCP)):
        if(pkts[1].flags=='AS'):
            print("OPEN")
        elif(pkts[1].flags=='AR'):
                print("CLOSE")
tcpconnect('172.16.111.108',80)
```

##### 关闭状态：

 靶机检测自身端口状态 

![1638147907630](1638147907630.png)

 攻击者主机运行TCP connect scan python脚本 

![1638147932544](1638147932544.png)

靶机的Wireshark抓包

![1638149257811](1638149257811.png)

 攻击者主机nmap复刻 

![1638149277448](1638149277448.png)

##### 开放状态：

 攻击者主机运行TCP connect scan python脚本 

![1638149379639](1638149379639.png)

 靶机Wireshark抓包 

![1638149396168](1638149396168.png)

 攻击者主机nmap复刻 

![1638149412965](1638149412965.png)

 分析：TCP三次握手机制，攻击者主机向靶机发送连接请求后，收到靶机返回[SYN/ACK]数据包，抓包结果与预期结果一致。 

##### 被过滤状态

 攻击者主机运行TCP connect scan python脚本 

![1638149934228](1638149934228.png)

 靶机Wireshark抓包 

![1638149954036](1638149954036.png)

 攻击者主机nmap复刻 

![1638149965375](1638149965375.png)

 分析：TCP三次握手机制，攻击者主机向靶机发送连接请求后，没有得到任何响应，抓包结果与预期结果一致。 

### TCP stealth scan 

攻击者主机编写 tcpstealth.py：

```python
from scapy.all import *
def tcpstealthscan(dst_ip , dst_port , timeout = 10):
    pkts = sr1(IP(dst=dst_ip)/TCP(dport=dst_port,flags="S"),timeout=10)
    if (pkts is None):
        print ("Filtered")
    elif(pkts.haslayer(TCP)):
        if(pkts.getlayer(TCP).flags == 0x12):
            send_rst = sr(IP(dst=dst_ip)/TCP(dport=dst_port,flags="R"),timeout=10)
            print ("Open")
        elif (pkts.getlayer(TCP).flags == 0x14):
            print ("Closed")
        elif(pkts.haslayer(ICMP)):
            if(int(pkts.getlayer(ICMP).type)==3 and int(stealth_scan_resp.getlayer(ICMP).code) in [1,2,3,9,10,13]):
                print ("Filtered")
tcpstealthscan('172.16.111.108',80)
```

##### 关闭状态：

![1638150052321](1638150052321.png)

 靶机Wireshark抓包 

![1638150122581](1638150122581.png)

 攻击者主机nmap复刻 

![1638150138192](1638150138192.png)

##### 开放状态 

![1638150177645](1638150177645.png)

靶机Wireshark抓包

![1638150190126](1638150190126.png)

 攻击者主机nmap复刻 

![1638150203119](1638150203119.png)

##### 被过滤状态

![1638150245933](1638150245933.png)

 靶机Wireshark抓包 

![1638150262715](1638150262715.png)

 攻击者主机nmap复刻 

![1638150276875](1638150276875.png)

### TCP Xmas scan

攻击者主机编写tcpxmas.py：

```python
from scapy.all import *
def Xmasscan(dst_ip , dst_port , timeout = 10):
    pkts = sr1(IP(dst=dst_ip)/TCP(dport=dst_port,flags="FPU"),timeout=10)
    if (pkts is None):
        print ("Open|Filtered")
    elif(pkts.haslayer(TCP)):
        if(pkts.getlayer(TCP).flags == 0x14):
            print ("Closed")
    elif(pkts.haslayer(ICMP)):
        if(int(pkts.getlayer(ICMP).type)==3 and int(pkts.getlayer(ICMP).code) in [1,2,3,9,10,13]):
            print ("Filtered")
Xmasscan('172.16.111.108',80)
```

##### 关闭状态

 靶机Wireshark抓包 

![1638150677819](1638150677819.png)

 攻击者主机nmap复刻 

![1638150695355](1638150695355.png)

 分析：Xmas发送TCP请求，在靶机端口关闭状态下，靶机响应[RST，ACK]，抓包结果与预期结果一致。 

##### 开放状态：

![1638150756004](1638150756004.png)

 靶机Wireshark抓包 

![1638150769286](1638150769286.png)

攻击者主机nmap复刻

![1638150783899](1638150783899.png)

 分析：Xmas发送TCP请求，在靶机端口开放状态下，靶机无响应，抓包结果与预期结果一致。 

##### 被过滤状态

![1638150832284](1638150832284.png)

 靶机Wireshark抓包 

![1638150848418](1638150848418.png)

 攻击者主机nmap复刻 

![1638150864002](1638150864002.png)

 分析：Xmas发送TCP请求，在靶机端口被过滤状态下，靶机无响应，抓包结果与预期结果一致。 

### TCP fin scan 

攻击者主机编写tcpfin.py：

```python
from scapy.all import *
def finscan(dst_ip , dst_port , timeout = 10):
    pkts = sr1(IP(dst=dst_ip)/TCP(dport=dst_port,flags="F"),timeout=10)#发送FIN包
    if (pkts is None):
        print ("Open|Filtered")
    elif(pkts.haslayer(TCP)):
        if(pkts.getlayer(TCP).flags == 0x14):
            print ("Closed")
    elif(pkts.haslayer(ICMP)):
        if(int(pkts.getlayer(ICMP).type)==3 and int(pkts.getlayer(ICMP).code) in [1,2,3,9,10,13]):
            print ("Filtered")
finscan('172.16.111.108',80)
```

##### 关闭状态：

![1638150943469](1638150943469.png)

 靶机Wireshark抓包 

![1638150960618](1638150960618.png)

 攻击者主机nmap复刻 

![1638150974419](1638150974419.png)

##### 开放状态

![1638151000780](1638151000780.png)

 靶机Wireshark抓包 

![1638151013958](1638151013958.png)

 攻击者主机nmap复刻 

![1638151036064](1638151036064.png)

##### 被过滤状态

![1638151056974](1638151056974.png)

 靶机Wireshark抓包 

![1638151074502](1638151074502.png)

攻击者主机nmap复刻

![1638151087212](1638151087212.png)

 ### TCP null scan 

攻击者主机编写tcpnull.py

```python
from scapy.all import *
def nullscan(dst_ip , dst_port , timeout = 10):
    pkts = sr1(IP(dst=dst_ip)/TCP(dport=dst_port,flags=""),timeout=10)
    if (pkts is None):
        print ("Open|Filtered")
    elif(pkts.haslayer(TCP)):
        if(pkts.getlayer(TCP).flags == 0x14):
            print ("Closed")
    elif(pkts.haslayer(ICMP)):
        if(int(pkts.getlayer(ICMP).type)==3 and int(pkts.getlayer(ICMP).code) in [1,2,3,9,10,13]):
            print ("Filtered")
nullscan('172.16.111.108',80)
```

##### 关闭状态

![1638151161419](1638151161419.png)

 靶机Wireshark抓包 

![1638151176108](1638151176108.png)

 攻击者主机nmap复刻 

![1638151191578](1638151191578.png)

##### 开放状态

![1638151289800](1638151289800.png)

 靶机Wireshark抓包 

![1638151302200](1638151302200.png)

攻击者主机nmap复刻

![1638151318083](1638151318083.png)

##### 被过滤状态

![1638151366587](1638151366587.png)

 靶机Wireshark抓包 

![1638151381776](1638151381776.png)

攻击者主机nmap复刻

![1638151395797](1638151395797.png)

### UDP scan

攻击者主机编写udp.py：

```python
from scapy.all import *
def udpscan(dst_ip,dst_port,dst_timeout = 10):
    resp = sr1(IP(dst=dst_ip)/UDP(dport=dst_port),timeout=dst_timeout)
    if (resp is None):
        print("Open|Filtered")
    elif (resp.haslayer(UDP)):
        print("Open")
    elif(resp.haslayer(ICMP)):
        if(int(resp.getlayer(ICMP).type)==3 and int(resp.getlayer(ICMP).code)==3):
            print("Closed")
        elif(int(resp.getlayer(ICMP).type)==3 and int(resp.getlayer(ICMP).code) in [1,2,9,10,13]):
            print("Filtered")
        elif(resp.haslayer(IP) and resp.getlayer(IP).proto==IP_PROTOS.udp):
            print("Open")
udpscan('172.16.111.108',53)
```

##### 关闭状态

![1638151466513](1638151466513.png)

 靶机Wireshark抓包 

![1638151480698](1638151480698.png)

 攻击者主机nmap复刻 

![1638151494635](1638151494635.png)

 分析：UDP扫描属于开放式扫描，靶机udp/53 端口关闭状态下，对攻击者主机并无任何响应，抓包结果与预期结果一致。 

##### 开放状态

![1638151627606](1638151627606.png)

靶机Wireshark抓包

![1638151640060](1638151640060.png)

 攻击者主机nmap复刻 

![1638151653927](1638151653927.png)

分析：UDP扫描属于开放式扫描，靶机udp/53 端口开启状态下，对攻击者主机并无任何响应，无法判断被过滤或开启，抓包结果与预期结果一致。

##### 被过滤状态

 靶机Wireshark抓包 

![1638151699721](1638151699721.png)

 攻击者主机nmap复刻 

![1638151715072](1638151715072.png)

分析：UDP扫描属于开放式扫描，靶机udp/53 端口被过滤状态下，对攻击者主机并无任何响应，无法判断被过滤或开启，抓包结果与预期结果一致。 